<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내 URL 목록 - QuickURL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
      }
    </style>
  </head>
  <body class="bg-slate-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-slate-800 text-white p-8">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-3xl md:text-4xl font-bold">📋 내 URL 목록</h1>
          <a href="/" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">
            ← 홈으로
          </a>
        </div>
        <p class="text-slate-300">등록한 단축 URL을 관리하세요</p>
      </div>

      <!-- Content -->
      <div class="p-6 md:p-8">
        <!-- Loading State -->
        <div id="loading" class="text-center py-16">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-slate-800 border-t-transparent"></div>
          <p class="mt-4 text-lg text-slate-700 font-medium">로딩 중...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-16">
          <div class="text-red-500 text-5xl mb-4">⚠️</div>
          <p class="text-xl text-red-600 font-medium">데이터를 불러오는 중 오류가 발생했습니다.</p>
        </div>

        <!-- URL List -->
        <div id="urlList" class="hidden grid gap-4 md:gap-6">
          <!-- URL 목록이 여기에 동적으로 추가됩니다 -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
          <div class="text-7xl mb-6">🔗</div>
          <h2 class="text-2xl font-bold text-gray-800 mb-3">등록된 URL이 없습니다</h2>
          <p class="text-gray-600 mb-6">첫 번째 단축 URL을 만들어보세요!</p>
          <a href="/" class="inline-block bg-slate-800 hover:bg-slate-700 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-md">
            URL 단축하러 가기
          </a>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden flex justify-center items-center gap-4 mt-8 pt-6 border-t border-gray-200">
          <button id="prevBtn" onclick="goToPage(currentPage - 1)" 
                  class="px-6 py-2 border-2 border-slate-800 text-slate-800 rounded-lg font-medium hover:bg-slate-800 hover:text-white transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-slate-800">
            이전
          </button>
          <span id="pageInfo" class="text-gray-700 font-medium px-4"></span>
          <button id="nextBtn" onclick="goToPage(currentPage + 1)" 
                  class="px-6 py-2 border-2 border-slate-800 text-slate-800 rounded-lg font-medium hover:bg-slate-800 hover:text-white transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-slate-800">
            다음
          </button>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
          <div class="text-center mb-6">
            <div class="text-red-500 text-6xl mb-4">⚠️</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">URL 삭제 확인</h3>
            <p class="text-gray-600">정말로 이 URL을 삭제하시겠습니까?</p>
            <p class="text-sm text-red-500 mt-2">이 작업은 되돌릴 수 없습니다.</p>
          </div>
          
          <div id="deleteUrlInfo" class="bg-slate-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
            <!-- URL 정보가 여기에 동적으로 추가됩니다 -->
          </div>

          <div class="flex gap-3">
            <button onclick="closeDeleteModal()" 
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-colors">
              취소
            </button>
            <button id="confirmDeleteBtn" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              삭제
            </button>
          </div>
        </div>
      </div>

      <!-- QR Code Modal -->
      <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">🔲 QR 코드</h3>
            <p class="text-sm text-gray-600" id="qrModalShortUrl"></p>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-6 mb-6 flex justify-center border-2 border-gray-200">
            <img id="qrModalImage" src="" alt="QR Code" class="max-w-full h-auto"/>
          </div>

          <div class="flex gap-3">
            <button onclick="downloadQrCode()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              💾 다운로드
            </button>
            <button onclick="closeQrModal()" 
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              닫기
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let currentPage = /*[[${pageNumber}]]*/ 0;
      let pageSize = /*[[${pageSize}]]*/ 20;
      let totalPages = 0;
      let isLastPage = false;

      async function fetchMyUrls(page = 0) {
        try {
          showLoading();

          const response = await fetch(`/api/v1/urls/me?page=${page}&size=${pageSize}&sort=createdAt,desc`);

          if (!response.ok) {
            throw new Error('Failed to fetch URLs');
          }

          const result = await response.json();
          currentPage = page; // 현재 페이지 업데이트
          displayUrls(result.data);

        } catch (error) {
          console.error('Error fetching URLs:', error);
          showError();
        }
      }

      function displayUrls(data) {
        const urlList = document.getElementById('urlList');
        const pagination = document.getElementById('pagination');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');

        loading.classList.add('hidden');
        error.classList.add('hidden');

        // API 응답 구조: { data: { items: [...], total_pages: N, total_count: N } }
        if (!data.items || data.items.length === 0) {
          emptyState.classList.remove('hidden');
          urlList.classList.add('hidden');
          pagination.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        urlList.classList.remove('hidden');
        pagination.classList.remove('hidden');

        // 페이지 정보 업데이트
        totalPages = data.total_pages;
        isLastPage = (currentPage + 1) >= totalPages;

        // URL 카드 생성
        urlList.innerHTML = data.items.map(url => createUrlCard(url)).join('');

        // 페이지 정보 및 버튼 상태 업데이트
        updatePaginationInfo();
      }

      function createUrlCard(url) {
        const shortUrl = `${window.location.origin}/${url.short_key}`;
        const createdDate = new Date(url.created_at).toLocaleString('ko-KR');
        const lastUsedDate = new Date(url.last_used_at).toLocaleString('ko-KR');
        
        // expiresAt 정보 생성
        let expirationInfo = '';
        if (url.expires_at) {
          const expiresDate = new Date(url.expires_at).toLocaleString('ko-KR');
          expirationInfo = `
            <div class="flex items-center gap-2 text-sm">
              <span class="text-amber-600">⏰</span>
              <span class="text-gray-600">만료일:</span>
              <span class="font-semibold text-amber-700">${expiresDate}</span>
            </div>
          `;
        } else {
          expirationInfo = `
            <div class="flex items-center gap-2 text-sm">
              <span class="text-blue-600">⏰</span>
              <span class="text-gray-600">만료 정책:</span>
              <span class="font-semibold text-blue-700">마지막 사용일로부터 90일 후</span>
            </div>
          `;
        }

        return `
          <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:shadow-lg hover:border-slate-400 transition-all duration-300">
            <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3 mb-4">
              <div class="flex-1 min-w-0">
                <div class="text-xl font-bold text-slate-800 break-all mb-2">${shortUrl}</div>
                <div class="flex flex-col gap-2">
                  <div class="flex items-center gap-3 text-sm text-gray-500">
                    <span>📅 생성: ${createdDate}</span>
                  </div>
                  <div class="flex items-center gap-3 text-sm text-gray-500">
                    <span>🕐 마지막 사용: ${lastUsedDate}</span>
                    <span class="text-slate-600">•</span>
                    <span class="flex items-center gap-1">
                      <span class="text-blue-600">👆</span>
                      <span class="font-semibold text-blue-700">${url.click_count.toLocaleString()}</span>
                      <span>클릭</span>
                    </span>
                  </div>
                  ${expirationInfo}
                </div>
              </div>
            </div>
            
            <div class="bg-slate-50 border-l-4 border-slate-700 rounded-lg p-4 mb-4">
              <div class="text-sm text-gray-600 font-medium mb-1">원본 URL:</div>
              <div class="text-gray-800 break-all">${url.original_url}</div>
            </div>
            
            <div class="flex flex-wrap gap-2">
              <button onclick="copyToClipboard('${shortUrl}')" 
                      class="flex-1 min-w-[120px] bg-slate-800 hover:bg-slate-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                📋 복사
              </button>
              <button onclick="window.open('${shortUrl}', '_blank')" 
                      class="flex-1 min-w-[120px] bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                🔗 열기
              </button>
              <button onclick="generateAndShowQrCode('${url.short_key}')" 
                      class="flex-1 min-w-[120px] bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                🔲 QR 코드
              </button>
              <button onclick="openDeleteModal('${url.short_key}', '${shortUrl}', '${url.original_url.replace(/'/g, "\\'")}')" 
                      class="flex-1 min-w-[120px] bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                🗑️ 삭제
              </button>
            </div>
          </div>
        `;
      }

      function updatePaginationInfo() {
        document.getElementById('pageInfo').textContent =
          `${currentPage + 1} / ${totalPages === 0 ? 1 : totalPages}`;

        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = isLastPage;
      }

      function goToPage(page) {
        if (page < 0 || page >= totalPages) return;
        fetchMyUrls(page);
      }

      function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('urlList').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
      }

      function showError() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('urlList').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          // 간단한 토스트 알림
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '✅ 클립보드에 복사되었습니다!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        } catch (err) {
          console.error('복사 실패:', err);
          alert('복사에 실패했습니다.');
        }
      }

      // 삭제 모달 관련 변수
      let deleteTargetShortKey = null;

      function openDeleteModal(shortKey, shortUrl, originalUrl) {
        deleteTargetShortKey = shortKey;
        const modal = document.getElementById('deleteModal');
        const urlInfo = document.getElementById('deleteUrlInfo');
        
        urlInfo.innerHTML = `
          <div class="text-sm text-gray-600 font-medium mb-1">단축 URL:</div>
          <div class="text-gray-800 font-semibold break-all mb-3">${shortUrl}</div>
          <div class="text-sm text-gray-600 font-medium mb-1">원본 URL:</div>
          <div class="text-gray-800 break-all">${originalUrl}</div>
        `;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        deleteTargetShortKey = null;
      }

      async function deleteUrl() {
        if (!deleteTargetShortKey) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.textContent;
        
        try {
          confirmBtn.disabled = true;
          confirmBtn.textContent = '삭제 중...';
          
          const response = await fetch(`/api/v1/url/shorten/${deleteTargetShortKey}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('Failed to delete URL');
          }

          // 성공 토스트
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '✅ URL이 삭제되었습니다!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

          // 모달 닫기
          closeDeleteModal();

          // 현재 페이지 다시 로드
          await fetchMyUrls(currentPage);

        } catch (error) {
          console.error('삭제 실패:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '❌ 삭제에 실패했습니다.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = originalText;
        }
      }

      // 확인 버튼에 이벤트 리스너 추가
      document.getElementById('confirmDeleteBtn').addEventListener('click', deleteUrl);

      // 모달 외부 클릭 시 닫기
      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          closeDeleteModal();
        }
      });

      // ESC 키로 모달 닫기
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDeleteModal();
          closeQrModal();
        }
      });

      // QR 코드 모달 관련 함수
      let currentQrShortKey = null;
      let currentQrImageData = null;

      async function generateAndShowQrCode(shortKey) {
        const shortUrl = `${window.location.origin}/${shortKey}`;
        currentQrShortKey = shortKey;

        try {
          // QR 코드 생성 요청
          const response = await fetch(`/api/v1/url/qr-code?shortKey=${encodeURIComponent(shortKey)}&size=300`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('QR 코드 생성에 실패했습니다.');
          }

          const data = await response.json();
          currentQrImageData = data.data.qr_code_image;
          
          // 모달에 QR 코드 표시
          document.getElementById('qrModalShortUrl').textContent = shortUrl;
          document.getElementById('qrModalImage').src = `data:image/png;base64,${currentQrImageData}`;
          document.getElementById('qrModal').classList.remove('hidden');
          document.body.style.overflow = 'hidden';

        } catch (error) {
          console.error('QR 코드 생성 실패:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '❌ QR 코드 생성에 실패했습니다.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }
      }

      function closeQrModal() {
        document.getElementById('qrModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        currentQrShortKey = null;
        currentQrImageData = null;
      }

      function downloadQrCode() {
        if (!currentQrImageData || !currentQrShortKey) return;

        try {
          // Base64를 Blob으로 변환
          const byteCharacters = atob(currentQrImageData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'image/png' });

          // 다운로드 링크 생성
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `qrcode-${currentQrShortKey}.png`;
          document.body.appendChild(a);
          a.click();
          
          // 정리
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // 성공 토스트
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '✅ QR 코드가 다운로드되었습니다!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

        } catch (error) {
          console.error('다운로드 실패:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = '❌ 다운로드에 실패했습니다.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }
      }

      // QR 모달 외부 클릭 시 닫기
      document.getElementById('qrModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'qrModal') {
          closeQrModal();
        }
      });

      // 페이지 로드 시 첫 페이지 데이터 가져오기
      window.addEventListener('DOMContentLoaded', () => {
        fetchMyUrls(currentPage);
      });
    </script>
  </body>
</html>