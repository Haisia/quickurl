<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ URL ëª©ë¡ - QuickURL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
      }
    </style>
  </head>
  <body class="bg-slate-100 min-h-screen p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Header -->
      <div class="bg-slate-800 text-white p-8">
        <div class="flex justify-between items-center mb-4">
          <h1 class="text-3xl md:text-4xl font-bold">ğŸ“‹ ë‚´ URL ëª©ë¡</h1>
          <a href="/" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-medium transition-colors">
            â† í™ˆìœ¼ë¡œ
          </a>
        </div>
        <p class="text-slate-300">ë“±ë¡í•œ ë‹¨ì¶• URLì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
      </div>

      <!-- Content -->
      <div class="p-6 md:p-8">
        <!-- Loading State -->
        <div id="loading" class="text-center py-16">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-slate-800 border-t-transparent"></div>
          <p class="mt-4 text-lg text-slate-700 font-medium">ë¡œë”© ì¤‘...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden text-center py-16">
          <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
          <p class="text-xl text-red-600 font-medium">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- URL List -->
        <div id="urlList" class="hidden grid gap-4 md:gap-6">
          <!-- URL ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
          <div class="text-7xl mb-6">ğŸ”—</div>
          <h2 class="text-2xl font-bold text-gray-800 mb-3">ë“±ë¡ëœ URLì´ ì—†ìŠµë‹ˆë‹¤</h2>
          <p class="text-gray-600 mb-6">ì²« ë²ˆì§¸ ë‹¨ì¶• URLì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
          <a href="/" class="inline-block bg-slate-800 hover:bg-slate-700 text-white px-8 py-3 rounded-lg font-medium transition-colors shadow-md">
            URL ë‹¨ì¶•í•˜ëŸ¬ ê°€ê¸°
          </a>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden flex justify-center items-center gap-4 mt-8 pt-6 border-t border-gray-200">
          <button id="prevBtn" onclick="goToPage(currentPage - 1)" 
                  class="px-6 py-2 border-2 border-slate-800 text-slate-800 rounded-lg font-medium hover:bg-slate-800 hover:text-white transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-slate-800">
            ì´ì „
          </button>
          <span id="pageInfo" class="text-gray-700 font-medium px-4"></span>
          <button id="nextBtn" onclick="goToPage(currentPage + 1)" 
                  class="px-6 py-2 border-2 border-slate-800 text-slate-800 rounded-lg font-medium hover:bg-slate-800 hover:text-white transition-all disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent disabled:hover:text-slate-800">
            ë‹¤ìŒ
          </button>
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
          <div class="text-center mb-6">
            <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">URL ì‚­ì œ í™•ì¸</h3>
            <p class="text-gray-600">ì •ë§ë¡œ ì´ URLì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p class="text-sm text-red-500 mt-2">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
          
          <div id="deleteUrlInfo" class="bg-slate-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
            <!-- URL ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>

          <div class="flex gap-3">
            <button onclick="closeDeleteModal()" 
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition-colors">
              ì·¨ì†Œ
            </button>
            <button id="confirmDeleteBtn" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              ì‚­ì œ
            </button>
          </div>
        </div>
      </div>

      <!-- QR Code Modal -->
      <div id="qrModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
          <div class="text-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">ğŸ”² QR ì½”ë“œ</h3>
            <p class="text-sm text-gray-600" id="qrModalShortUrl"></p>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-6 mb-6 flex justify-center border-2 border-gray-200">
            <img id="qrModalImage" src="" alt="QR Code" class="max-w-full h-auto"/>
          </div>

          <div class="flex gap-3">
            <button onclick="downloadQrCode()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              ğŸ’¾ ë‹¤ìš´ë¡œë“œ
            </button>
            <button onclick="closeQrModal()" 
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
              ë‹«ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let currentPage = /*[[${pageNumber}]]*/ 0;
      let pageSize = /*[[${pageSize}]]*/ 20;
      let totalPages = 0;
      let isLastPage = false;

      async function fetchMyUrls(page = 0) {
        try {
          showLoading();

          const response = await fetch(`/api/v1/urls/me?page=${page}&size=${pageSize}&sort=createdAt,desc`);

          if (!response.ok) {
            throw new Error('Failed to fetch URLs');
          }

          const result = await response.json();
          currentPage = page; // í˜„ì¬ í˜ì´ì§€ ì—…ë°ì´íŠ¸
          displayUrls(result.data);

        } catch (error) {
          console.error('Error fetching URLs:', error);
          showError();
        }
      }

      function displayUrls(data) {
        const urlList = document.getElementById('urlList');
        const pagination = document.getElementById('pagination');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');

        loading.classList.add('hidden');
        error.classList.add('hidden');

        // API ì‘ë‹µ êµ¬ì¡°: { data: { items: [...], total_pages: N, total_count: N } }
        if (!data.items || data.items.length === 0) {
          emptyState.classList.remove('hidden');
          urlList.classList.add('hidden');
          pagination.classList.add('hidden');
          return;
        }

        emptyState.classList.add('hidden');
        urlList.classList.remove('hidden');
        pagination.classList.remove('hidden');

        // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
        totalPages = data.total_pages;
        isLastPage = (currentPage + 1) >= totalPages;

        // URL ì¹´ë“œ ìƒì„±
        urlList.innerHTML = data.items.map(url => createUrlCard(url)).join('');

        // í˜ì´ì§€ ì •ë³´ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updatePaginationInfo();
      }

      function createUrlCard(url) {
        const shortUrl = `${window.location.origin}/${url.short_key}`;
        const createdDate = new Date(url.created_at).toLocaleString('ko-KR');
        const lastUsedDate = new Date(url.last_used_at).toLocaleString('ko-KR');
        
        // expiresAt ì •ë³´ ìƒì„±
        let expirationInfo = '';
        if (url.expires_at) {
          const expiresDate = new Date(url.expires_at).toLocaleString('ko-KR');
          expirationInfo = `
            <div class="flex items-center gap-2 text-sm">
              <span class="text-amber-600">â°</span>
              <span class="text-gray-600">ë§Œë£Œì¼:</span>
              <span class="font-semibold text-amber-700">${expiresDate}</span>
            </div>
          `;
        } else {
          expirationInfo = `
            <div class="flex items-center gap-2 text-sm">
              <span class="text-blue-600">â°</span>
              <span class="text-gray-600">ë§Œë£Œ ì •ì±…:</span>
              <span class="font-semibold text-blue-700">ë§ˆì§€ë§‰ ì‚¬ìš©ì¼ë¡œë¶€í„° 90ì¼ í›„</span>
            </div>
          `;
        }

        return `
          <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:shadow-lg hover:border-slate-400 transition-all duration-300">
            <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3 mb-4">
              <div class="flex-1 min-w-0">
                <div class="text-xl font-bold text-slate-800 break-all mb-2">${shortUrl}</div>
                <div class="flex flex-col gap-2">
                  <div class="flex items-center gap-3 text-sm text-gray-500">
                    <span>ğŸ“… ìƒì„±: ${createdDate}</span>
                  </div>
                  <div class="flex items-center gap-3 text-sm text-gray-500">
                    <span>ğŸ• ë§ˆì§€ë§‰ ì‚¬ìš©: ${lastUsedDate}</span>
                    <span class="text-slate-600">â€¢</span>
                    <span class="flex items-center gap-1">
                      <span class="text-blue-600">ğŸ‘†</span>
                      <span class="font-semibold text-blue-700">${url.click_count.toLocaleString()}</span>
                      <span>í´ë¦­</span>
                    </span>
                  </div>
                  ${expirationInfo}
                </div>
              </div>
            </div>
            
            <div class="bg-slate-50 border-l-4 border-slate-700 rounded-lg p-4 mb-4">
              <div class="text-sm text-gray-600 font-medium mb-1">ì›ë³¸ URL:</div>
              <div class="text-gray-800 break-all">${url.original_url}</div>
            </div>
            
            <div class="flex flex-wrap gap-2">
              <button onclick="copyToClipboard('${shortUrl}')" 
                      class="flex-1 min-w-[120px] bg-slate-800 hover:bg-slate-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                ğŸ“‹ ë³µì‚¬
              </button>
              <button onclick="window.open('${shortUrl}', '_blank')" 
                      class="flex-1 min-w-[120px] bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                ğŸ”— ì—´ê¸°
              </button>
              <button onclick="generateAndShowQrCode('${url.short_key}')" 
                      class="flex-1 min-w-[120px] bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                ğŸ”² QR ì½”ë“œ
              </button>
              <button onclick="openDeleteModal('${url.short_key}', '${shortUrl}', '${url.original_url.replace(/'/g, "\\'")}')" 
                      class="flex-1 min-w-[120px] bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors shadow-sm">
                ğŸ—‘ï¸ ì‚­ì œ
              </button>
            </div>
          </div>
        `;
      }

      function updatePaginationInfo() {
        document.getElementById('pageInfo').textContent =
          `${currentPage + 1} / ${totalPages === 0 ? 1 : totalPages}`;

        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = isLastPage;
      }

      function goToPage(page) {
        if (page < 0 || page >= totalPages) return;
        fetchMyUrls(page);
      }

      function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('urlList').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
      }

      function showError() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('urlList').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ì•Œë¦¼
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        } catch (err) {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
          alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // ì‚­ì œ ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜
      let deleteTargetShortKey = null;

      function openDeleteModal(shortKey, shortUrl, originalUrl) {
        deleteTargetShortKey = shortKey;
        const modal = document.getElementById('deleteModal');
        const urlInfo = document.getElementById('deleteUrlInfo');
        
        urlInfo.innerHTML = `
          <div class="text-sm text-gray-600 font-medium mb-1">ë‹¨ì¶• URL:</div>
          <div class="text-gray-800 font-semibold break-all mb-3">${shortUrl}</div>
          <div class="text-sm text-gray-600 font-medium mb-1">ì›ë³¸ URL:</div>
          <div class="text-gray-800 break-all">${originalUrl}</div>
        `;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        deleteTargetShortKey = null;
      }

      async function deleteUrl() {
        if (!deleteTargetShortKey) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.textContent;
        
        try {
          confirmBtn.disabled = true;
          confirmBtn.textContent = 'ì‚­ì œ ì¤‘...';
          
          const response = await fetch(`/api/v1/url/shorten/${deleteTargetShortKey}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('Failed to delete URL');
          }

          // ì„±ê³µ í† ìŠ¤íŠ¸
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âœ… URLì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

          // ëª¨ë‹¬ ë‹«ê¸°
          closeDeleteModal();

          // í˜„ì¬ í˜ì´ì§€ ë‹¤ì‹œ ë¡œë“œ
          await fetchMyUrls(currentPage);

        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âŒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = originalText;
        }
      }

      // í™•ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.getElementById('confirmDeleteBtn').addEventListener('click', deleteUrl);

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          closeDeleteModal();
        }
      });

      // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDeleteModal();
          closeQrModal();
        }
      });

      // QR ì½”ë“œ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
      let currentQrShortKey = null;
      let currentQrImageData = null;

      async function generateAndShowQrCode(shortKey) {
        const shortUrl = `${window.location.origin}/${shortKey}`;
        currentQrShortKey = shortKey;

        try {
          // QR ì½”ë“œ ìƒì„± ìš”ì²­
          const response = await fetch(`/api/v1/url/qr-code?shortKey=${encodeURIComponent(shortKey)}&size=300`, {
            credentials: 'include'
          });

          if (!response.ok) {
            throw new Error('QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }

          const data = await response.json();
          currentQrImageData = data.data.qr_code_image;
          
          // ëª¨ë‹¬ì— QR ì½”ë“œ í‘œì‹œ
          document.getElementById('qrModalShortUrl').textContent = shortUrl;
          document.getElementById('qrModalImage').src = `data:image/png;base64,${currentQrImageData}`;
          document.getElementById('qrModal').classList.remove('hidden');
          document.body.style.overflow = 'hidden';

        } catch (error) {
          console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âŒ QR ì½”ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }
      }

      function closeQrModal() {
        document.getElementById('qrModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        currentQrShortKey = null;
        currentQrImageData = null;
      }

      function downloadQrCode() {
        if (!currentQrImageData || !currentQrShortKey) return;

        try {
          // Base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
          const byteCharacters = atob(currentQrImageData);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: 'image/png' });

          // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `qrcode-${currentQrShortKey}.png`;
          document.body.appendChild(a);
          a.click();
          
          // ì •ë¦¬
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // ì„±ê³µ í† ìŠ¤íŠ¸
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âœ… QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);

        } catch (error) {
          console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
          const toast = document.createElement('div');
          toast.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
          toast.textContent = 'âŒ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 2000);
        }
      }

      // QR ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.getElementById('qrModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'qrModal') {
          closeQrModal();
        }
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      window.addEventListener('DOMContentLoaded', () => {
        fetchMyUrls(currentPage);
      });
    </script>
  </body>
</html>